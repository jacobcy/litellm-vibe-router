version: '3.8'

services:
  # ==================================
  # CLIProxyAPI (chat-auto dedicated API)
  # ==================================
  cliproxyapi:
    build:
      context: ./CLIProxyAPI
    container_name: cli-proxy-api

    ports:
      - "8317:8317"

    volumes:
      - ./cliproxyapi.config.yaml:/CLIProxyAPI/config.yaml:ro
      - cliproxy_auth:/cli-proxy-auth

    restart: unless-stopped

  # ==================================
  # PostgreSQL for LiteLLM Admin UI
  # ==================================
  postgres:
    image: postgres:15-alpine
    container_name: litellm-vibe-postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=litellm
      - POSTGRES_USER=litellm
      - POSTGRES_PASSWORD=litellm_password
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U litellm" ]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==================================
  # LiteLLM Proxy with Intelligent Router
  # ==================================
  litellm:
    image: ghcr.io/berriai/litellm:main-stable
    container_name: litellm-vibe-router
    user: root

    # Load environment variables from .env file
    env_file:
      - .env

    ports:
      - "4000:4000"

    volumes:
      # Mount final config and router plugin
      - ./config_final.yaml:/app/config.yaml:ro
      - ./vibe_router.py:/app/vibe_router.py:ro

      # Optional: mount test script for in-container testing
      - ./test_route.py:/app/test_route.py:ro

    environment:
      # CRITICAL: Python path for plugin import
      - PYTHONPATH=/app

      # Database connection for Admin UI
      - DATABASE_URL=postgresql://litellm:litellm_password@postgres:5432/litellm

      # Redis connection
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # Admin UI credentials
      - UI_USERNAME=admin
      - UI_PASSWORD=admin123

      # Logging level (INFO, DEBUG, WARNING, ERROR)
      - LOG_LEVEL=INFO

      # Level 2: New API configuration
      - NEW_API_BASE=http://host.docker.internal:3000/v1
      - NEW_API_KEY=${NEW_API_KEY}

      # Level 1: CLIProxyAPI configuration
      - CHAT_AUTO_API_KEY=${CHAT_AUTO_API_KEY}

      # Level 3: Volces Ark API (from .env)
      - ARK_API_KEY=${ARK_API_KEY}
      - ARK_OPENAI_BASE=${ARK_OPENAI_BASE}
      - ARK_CLAUDE_BASE=${ARK_CLAUDE_BASE}

      # LiteLLM Master Key (from .env)
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}

      # Anthropic API key for claude models (from .env)
      - ANTHROPIC_API_KEY=${NEW_API_KEY}
      # Optional: Enable debug mode
      # - LITELLM_LOG=DEBUG

    extra_hosts:
      # Allow container to reach host services (New API on port 3000)
      - "host.docker.internal:host-gateway"

    command:
      - "--config"
      - "/app/config.yaml"
      - "--port"
      - "4000"
      - "--detailed_debug"

    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
      cliproxyapi:
        condition: service_started

    restart: unless-stopped

    # Health check
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:4000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==================================
  # Redis for LiteLLM caching
  # ==================================
  redis:
    image: redis:alpine
    container_name: litellm-vibe-redis

    ports:
      - "6379:6379"

    volumes:
      - redis_data:/data

    command: redis-server --appendonly yes

    restart: unless-stopped

    # Health check
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

# ==================================
# Volumes
# ==================================
volumes:
  cliproxy_auth:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local

# ==================================
# Networks (optional)
# ==================================
networks:
  default:
    name: litellm-network
